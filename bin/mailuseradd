#!/bin/sh

if [ $# -ne 2 ]; then
  cat <<EOF >&2
Usage: mailuseradd IP USERNAME
EOF
  exit 1
fi

TMPDIR=${TMPDIR:-/tmp}
TMPFILE=`mktemp "$TMPDIR/mailuseradd.XXXXXX"` || exit 1
trap "rm -f -- \"$TMPFILE\"" 0 1 2 15

HOSTADDR=$1
USERNAME=$2

mailconfig -pr -- "$HOSTADDR" >"$TMPFILE" || exit 1

if pcregrep "^\Q$USERNAME\E(:|$)" "$TMPFILE" >/dev/null; then
  cat <<EOF >&2
mailuseradd: mail user $USERNAME already exists for this IP
EOF
  exit 1
fi

PASSWORD=`dovecotpw -s PLAIN` || exit 1
PASSWORD=`echo "$PASSWORD" | sed 's/^{[^}]*}//'` || exit 1
echo "$USERNAME:$PASSWORD" >>"$TMPFILE"
mailconfig -pws -- "$HOSTADDR" <"$TMPFILE" || exit 1
echo "Mail configuration successfully updated" >&2
